#!/usr/bin/env bash
# dev - Open Zellij dev environment at workspace root

set -euo pipefail

export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:$PATH"

WORKSPACE_ROOT="$HOME/Developer"

show_help() {
  cat <<'EOF'
dev - Open Zellij dev environment at workspace root

Usage:
  dev              Open workspace in Zellij
  dev -p "msg"     Open with initial prompt for Claude
  dev -h           Show this help message

Layout:
  Shell (33% left) + Claude (67% right)
  Both at ~/Developer

Claude reads CLAUDE.md at workspace root for context.
EOF
}

# Parse options
prompt=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      show_help
      exit 0
      ;;
    -p)
      if [[ -z "${2:-}" ]]; then
        echo "Option -p requires an argument" >&2
        exit 1
      fi
      prompt="$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
  esac
done

# Read zjstatus template from default layout
ZELLIJ_LAYOUT_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/zellij/layouts"
DEFAULT_TAB_TEMPLATE=$(sed -n '/default_tab_template {/,/^    }$/p' "$ZELLIJ_LAYOUT_DIR/default.kdl")

# Build claude command string
claude_cmd="CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1 exec claude --dangerously-skip-permissions"
if [[ -n "$prompt" ]]; then
  escaped_prompt="${prompt//\"/\\\"}"
  claude_cmd+=" \"$escaped_prompt\""
fi

# Create layout with Claude environment variables
layout_file="/tmp/zellij-dev-$$.kdl"
cat > "$layout_file" <<EOF
layout {
$DEFAULT_TAB_TEMPLATE
    tab focus=true name="dev" {
        pane split_direction="vertical" {
            pane size="33%" cwd="$WORKSPACE_ROOT"
            pane size="67%" focus=true cwd="$WORKSPACE_ROOT" command="bash" {
                args "-c" "$claude_cmd"
            }
        }
    }
}
EOF

# Launch zellij
if [[ -n "${ZELLIJ:-}" ]]; then
  zellij action new-tab --layout "$layout_file"
else
  zellij --layout "$layout_file"
fi

rm -f "$layout_file"
